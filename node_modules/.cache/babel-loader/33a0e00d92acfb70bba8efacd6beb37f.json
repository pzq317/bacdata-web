{"ast":null,"code":"import _classCallCheck from \"/Users/pzq317/Desktop/bacdata-web/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/pzq317/Desktop/bacdata-web/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/pzq317/Desktop/bacdata-web/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/pzq317/Desktop/bacdata-web/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/pzq317/Desktop/bacdata-web/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _assertThisInitialized from \"/Users/pzq317/Desktop/bacdata-web/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";\nvar _jsxFileName = \"/Users/pzq317/Desktop/bacdata-web/src/Sankey.js\";\nimport React, { Component } from 'react';\nimport * as d3 from 'd3';\nimport json from './data/world.json';\nimport csv from './data/world_trade_value.csv';\nimport categoryData from './data/category.csv';\nimport sankeyJson from './data/sankeyTest.json'; //import {sankey as Sankey, sankeyLinkHorizontal} from 'd3-sankey'\n\nimport { Sankey } from './d3.sankey.js';\nimport TimeLine from './TimeLine';\nimport TradeBtn from './TradeBtn';\nimport Pie from './PieChart';\nimport Line from './BarChart';\n\nvar SankeyGraph =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(SankeyGraph, _Component);\n\n  function SankeyGraph(props) {\n    var _this;\n\n    _classCallCheck(this, SankeyGraph);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(SankeyGraph).call(this, props));\n    _this.state = {\n      data: [],\n      category: [],\n      countries: [],\n      sankey: {},\n      width: '',\n      height: '',\n      margin: {},\n      country: '',\n      y: '',\n      count: 0,\n      piechartshow: 0\n    };\n    _this.upDate = _this.upDate.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    _this.setData = _this.setData.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    _this.drawChart = _this.drawChart.bind(_assertThisInitialized(_assertThisInitialized(_this)));\n    return _this;\n  }\n\n  _createClass(SankeyGraph, [{\n    key: \"shouldComponentUpdate\",\n    value: function shouldComponentUpdate(nextProps, nextState) {\n      if (this.props.trade !== nextProps.trade || this.props.year !== nextProps.year || this.props.country !== nextProps.country) {\n        return true;\n      } else {\n        return false;\n      }\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      /*var margin = {top: 50, right: 0, bottom: 0, left: 0},\n      width = 700 - margin.left - margin.right,\n      height = 500 - margin.top - margin.bottom;*/\n      //console.log('sankey width', +d3.select('#section2').style('width').slice(0, -2))\n      var margin = {\n        top: 50,\n        right: 0,\n        bottom: 0,\n        left: 0\n      },\n          width = +d3.select('#section2').style('width').slice(0, -2) * 0.65 - margin.left - margin.right,\n          height = +d3.select('#section2').style('height').slice(0, -2) * 0.7 - margin.top - margin.bottom;\n      var sankey = Sankey().nodeWidth(15).nodePadding(10).size([width, height]);\n      this.setState({\n        sankey: sankey,\n        width: width,\n        height: height,\n        margin: margin\n      });\n      d3.csv(csv, function (d) {\n        return {\n          Country: d.Country,\n          Year: +d.Year,\n          Trade: d.Trade,\n          Value: +d.Value\n        };\n      }.bind(this)).then(function (data) {\n        var _this2 = this;\n\n        this.setData(data).then(function () {\n          _this2.setState({\n            data: data\n          });\n\n          _this2.drawChart();\n        });\n      }.bind(this));\n      window.addEventListener('resize', this.upDate);\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate() {\n      var _this3 = this;\n\n      this.setData(this.state.data).then(function () {\n        _this3.upDate();\n\n        _this3.upDateTitle();\n      });\n    }\n  }, {\n    key: \"setData\",\n    value: function setData(data) {\n      var _this4 = this;\n\n      return new Promise(function (resolve) {\n        var countries = data.filter(function (d) {\n          return d.Trade == _this4.props.trade && d.Year == _this4.props.year;\n        }).sort(function (a, b) {\n          return b.Value - a.Value;\n        }).slice(0, 10).map(function (d) {\n          return d.Country;\n        });\n\n        _this4.setState({\n          countries: countries\n        });\n\n        d3.csv(categoryData, function (d) {\n          var year = this.props.year;\n          if (d.Trade == this.props.trade && countries.includes(d.Reporter)) return {\n            Reporter: d.Reporter,\n            Partner: d.Partner,\n            Product: d.Product,\n            Trade: d.Trade,\n            Value: +d[year],\n            Year: year\n          };\n        }.bind(_this4)).then(function (category) {\n          this.setState({\n            category: category\n          });\n          resolve('ture');\n        }.bind(_this4));\n      });\n    }\n  }, {\n    key: \"drawChart\",\n    value: function drawChart() {\n      var _this5 = this;\n\n      var category = this.state.category.filter(function (d) {\n        return d.Product == 'AllProducts';\n      });\n      this.createSankeyJson(category).then(function (sankeydata) {\n        //console.log(sankeydata)\n        var trade = _this5.props.trade;\n        var width = _this5.state.width,\n            height = _this5.state.height,\n            margin = _this5.state.margin;\n\n        var formatNumber = d3.format(\",.0f\"),\n            format = function format(d) {\n          return formatNumber(d) + \" TWh\";\n        },\n            color = d3.scaleOrdinal([\"#191970\", \"#000080\", \"#00008B\", \"#0000CD\", \"#0000FF\", \"#4169E1\", \"#6495ED\", \"#1E90FF\", \"#00BFFF\", \"#87CEFA\"]);\n\n        var svg = d3.select(\"#sankey-container\").append('svg').attr(\"width\", width + margin.left + margin.right).attr(\"height\", height + margin.top + margin.bottom).attr('id', 'sankey-svg');\n        d3.select(\"#sankey-container\").append('canvas').attr(\"width\", width + margin.left + margin.right).attr(\"height\", height + margin.top + margin.bottom).attr('id', 'sankey-canvas'); // var sankey = Sankey()\n        //     .nodeWidth(15)\n        //     .nodePadding(10)\n        //     .size([width, height]);\n\n        var sankey = _this5.state.sankey;\n        var path = sankey.link();\n        var freqCounter = 1;\n        sankey.nodes(sankeydata.nodes).links(sankeydata.links).layout(32);\n        var div = d3.select('.tooltip');\n        var link = svg.selectAll(\".link\").data(sankeydata.links).enter().append(\"path\").attr(\"class\", \"link\").attr(\"d\", path).attr('id', function (d) {\n          return d.source.name;\n        }).style('fill', 'none').style('stroke', '#000').style('stroke-opacity', 0.05).attr(\"stroke-width\", function (d) {\n          return Math.max(1, d.dy);\n        }).on(\"click\", function () {\n          setCountry(this.id);\n        }).on(\"mouseover\", function (d) {\n          d3.selectAll('#' + this.id).style('stroke-opacity', 0.25);\n          div.style(\"opacity\", .9).style('z-index', 10);\n          div.html(d.source.name + ' to ' + d.target.name + '<br>' + 'Value: ' + convert(d.value));\n\n          function convert(labelValue) {\n            // Nine Zeroes for Billions\n            return Math.abs(Number(labelValue)) >= 1.0e+9 ? Math.round(Math.abs(Number(labelValue)) / 1.0e+9 * 10) / 10 + \"B\" // Six Zeroes for Millions \n            : Math.abs(Number(labelValue)) >= 1.0e+6 ? Math.round(Math.abs(Number(labelValue)) / 1.0e+6 * 10) / 10 + \"M\" // Three Zeroes for Thousands\n            : Math.abs(Number(labelValue)) >= 1.0e+3 ? Math.round(Math.abs(Number(labelValue)) / 1.0e+3 * 10) / 10 + \"K\" : Math.abs(Number(labelValue));\n          }\n        }).on(\"mousemove\", function () {\n          div.style(\"left\", d3.event.pageX + 10 + \"px\").style(\"top\", d3.event.pageY - 10 + \"px\");\n        }).on(\"mouseleave\", function (d) {\n          d3.selectAll('#' + this.id).style('stroke-opacity', 0.05);\n          div.style(\"opacity\", 0).style('z-index', -10);\n        });\n        var rect = svg.selectAll(\"rect\").data(sankeydata.nodes).enter();\n        var text = svg.selectAll(\"text\").data(sankeydata.nodes).enter(); //.append(\"g\")\n        //.attr(\"class\", \"node\")\n        //.attr(\"transform\", function(d) { return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n\n        rect.append(\"rect\").attr('id', 'sankey-rect').attr('x', function (d) {\n          return d.x;\n        }).attr('y', function (d) {\n          return d.y;\n        }).attr(\"height\", function (d) {\n          return d.dy;\n        }).attr(\"width\", sankey.nodeWidth()).style(\"fill\", function (d) {\n          return d.color = color(d.name);\n        }).style(\"stroke\", \"none\").append(\"title\").text(function (d) {\n          return d.name + \"\\n\" + format(d.value);\n        });\n        text.append(\"text\").attr('id', 'sankey-text').attr('x', function (d) {\n          return d.x - 6;\n        }).attr('y', function (d) {\n          return d.y + d.dy / 2;\n        }).attr(\"dy\", \".35em\").attr(\"text-anchor\", \"end\").attr(\"transform\", null).text(function (d) {\n          return d.name;\n        }).filter(function (d) {\n          return d.x < width / 2;\n        }).attr(\"x\", 6 + sankey.nodeWidth()).attr(\"text-anchor\", \"start\");\n\n        var setCountry = function setCountry(e) {\n          /*console.log('set country')\n          if(this.state.count == 0){\n          \tthis.setState({\n          \t\tcountry: e,\n          \t\tcount:1,\n          \t\tpiechartshow:1\n          \t},this.drawPieChart)\n          }\n          else{\n          \tthis.setState({\n          \t\tcountry: e\n          \t})\n          }*/\n          _this5.props.countryStatus(e);\n        };\n\n        var linkExtent = d3.extent(sankeydata.links, function (d) {\n          return d.value;\n        });\n        var frequencyScale = d3.scaleLinear().domain(linkExtent).range([1, 100]);\n        var particleSize = d3.scaleLinear().domain(linkExtent).range([1, 5]);\n        sankeydata.links.forEach(function (link) {\n          link.freq = frequencyScale(link.value);\n          link.particleSize = particleSize(link.value);\n          link.particleColor = d3.scaleLinear().domain([0, 1000]).range([link.source.color, link.target.color]);\n        });\n        var t = d3.timer(tick, 2000);\n        var particles = [];\n\n        function tick(elapsed, time) {\n          particles = particles.filter(function (d) {\n            return d.time > elapsed - 2000;\n          });\n\n          if (freqCounter > 200) {\n            freqCounter = 1;\n          }\n\n          d3.selectAll(\"path.link\").each(function (d) {\n            if (d.freq >= freqCounter) {\n              var offset = (Math.random() - .5) * d.dy;\n              particles.push({\n                link: d,\n                time: elapsed,\n                offset: offset,\n                path: this\n              });\n            }\n          });\n          particleEdgeCanvasPath(elapsed);\n          freqCounter++;\n        }\n\n        function particleEdgeCanvasPath(elapsed) {\n          var context = d3.select(\"canvas\").node().getContext(\"2d\");\n          context.clearRect(0, 0, 2000, 2000);\n          context.fillStyle = \"gray\";\n          context.lineWidth = \"1px\";\n\n          for (var x in particles) {\n            var currentTime = elapsed - particles[x].time;\n            var currentPercent = currentTime / 2000 * particles[x].path.getTotalLength();\n            var currentPos = particles[x].path.getPointAtLength(currentPercent);\n            context.beginPath();\n            context.fillStyle = particles[x].link.particleColor(currentTime);\n            context.arc(currentPos.x, currentPos.y + particles[x].offset, particles[x].link.particleSize, 0, 2 * Math.PI);\n            context.fill();\n          }\n        }\n      });\n    }\n  }, {\n    key: \"upDate\",\n    value: function upDate() {\n      console.log('sankey update'); //d3.select('#sankey-discription-container').style('height',+d3.select('#section2').style('width').slice(0, -2) * 0.3)\n\n      var trade = this.props.trade;\n      var category = this.state.category.filter(function (d) {\n        return d.Product == 'AllProducts';\n      });\n      this.createSankeyJson(category).then(function (sankeydata) {\n        //console.log('sankey update width',+d3.select('#section2').style('width').slice(0, -2))\n        var margin = {\n          top: 50,\n          right: 0,\n          bottom: 0,\n          left: 0\n        },\n            width = +d3.select('#section2').style('width').slice(0, -2) * 0.65 - margin.left - margin.right,\n            height = +d3.select('#section2').style('height').slice(0, -2) * 0.7 - margin.top - margin.bottom; // width = 1000 - margin.left - margin.right,\n        // height = 500 - margin.top - margin.bottom;\n\n        d3.select(\"#sankey-svg\").attr(\"width\", width + margin.left + margin.right).attr(\"height\", height + margin.top + margin.bottom);\n        d3.select(\"#sankey-canvas\").attr(\"width\", width + margin.left + margin.right).attr(\"height\", height + margin.top + margin.bottom);\n        console.log(trade);\n\n        var formatNumber = d3.format(\",.0f\"),\n            format = function format(d) {\n          return formatNumber(d) + \" TWh\";\n        },\n            color = trade == 'Import' ? d3.scaleOrdinal([\"#800000\", \"#A52A2A\", \"#B22222\", \"#FF0000\", \"#DC143C\", \"#FFA07A\", \"#FA8072\", \"#F08080\", \"#CD5C5C\", \"#D2691E\"]) : d3.scaleOrdinal([\"#191970\", \"#000080\", \"#00008B\", \"#0000CD\", \"#0000FF\", \"#4169E1\", \"#6495ED\", \"#1E90FF\", \"#00BFFF\", \"#87CEFA\"]);\n\n        console.log('color', color('China'));\n        var svg = d3.select(\"#sankey-container\"); //var sankey = this.state.sankey\n\n        var sankey = Sankey().nodeWidth(15).nodePadding(10).size([width, height]);\n        var freqCounter = 1;\n        sankey.nodes(sankeydata.nodes).links(sankeydata.links).layout(32);\n        sankey.relayout();\n        var path = sankey.link();\n        var link = svg.selectAll(\".link\").data(sankeydata.links);\n        link.transition().duration(1000).attr(\"d\", path).attr(\"stroke-width\", function (d) {\n          return Math.max(1, d.dy);\n        }).attr('id', function (d) {\n          return trade == 'Export' ? d.source.name : d.target.name;\n        }); //.sort(function(a, b) { return b.dy - a.dy; })\n\n        link.enter().append(\"path\").attr(\"class\", \"link\").attr(\"d\", path).attr('id', function (d) {\n          return trade == 'Export' ? d.source.name : d.target.name;\n        }).attr(\"stroke-width\", function (d) {\n          return Math.max(1, d.dy);\n        }); //.sort(function(a, b) { return b.dy - a.dy; })\n\n        var rect = svg.selectAll(\"#sankey-rect\").data(sankeydata.nodes);\n        var text = svg.selectAll(\"#sankey-text\").data(sankeydata.nodes); //.attr(\"class\", \"node\")\n        //.attr(\"transform\", function(d) { return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n\n        rect.transition().duration(1000).attr('x', function (d) {\n          return d.x;\n        }).attr('y', function (d) {\n          return d.y;\n        }).attr(\"height\", function (d) {\n          return d.dy;\n        }) //.attr(\"width\", sankey.nodeWidth())\n        .style(\"fill\", function (d) {\n          return d.color = color(d.name);\n        })\n        /*.attr(\"stroke\", \"none\")\n        .append(\"title\")*/\n        .text(function (d) {\n          return d.name + \"\\n\" + format(d.value);\n        });\n        text.transition().duration(1000).attr('x', function (d) {\n          return d.x - 6;\n        }).attr('y', function (d) {\n          return d.y + d.dy / 2;\n        }).attr(\"dy\", \".35em\").attr(\"text-anchor\", \"end\").attr(\"transform\", null).text(function (d) {\n          return d.name;\n        }).filter(function (d) {\n          return d.x < width / 2;\n        }).attr(\"x\", 6 + sankey.nodeWidth()).attr(\"text-anchor\", \"start\");\n        rect.enter().append(\"rect\").transition().duration(1000).attr('id', 'sankey-rect').attr('x', function (d) {\n          return d.x;\n        }).attr('y', function (d) {\n          return d.y;\n        }).attr(\"height\", function (d) {\n          return d.dy;\n        }).attr(\"width\", sankey.nodeWidth()) //.style(\"fill\", function(d) { return d.color = color(d.name); })\n        .style(\"fill\", function (d) {\n          return d.color = color(d.name);\n        }).style(\"stroke\", \"none\"); //.append(\"title\")\n        //.text(function(d) { return d.name + \"\\n\" + format(d.value); });\n\n        text.enter().append(\"text\").transition().duration(1000).attr('id', 'sankey-text').attr('x', function (d) {\n          return d.x - 6;\n        }).attr('y', function (d) {\n          return d.y + d.dy / 2;\n        }).attr(\"dy\", \".35em\").attr(\"text-anchor\", \"end\").attr(\"transform\", null).text(function (d) {\n          return d.name;\n        }).filter(function (d) {\n          return d.x < width / 2;\n        }).attr(\"x\", 6 + sankey.nodeWidth()).attr(\"text-anchor\", \"start\");\n        rect.exit().remove();\n        text.exit().remove();\n        link.exit().remove();\n        var linkExtent = d3.extent(sankeydata.links, function (d) {\n          return d.value;\n        });\n        var frequencyScale = d3.scaleLinear().domain(linkExtent).range([1, 100]);\n        var particleSize = d3.scaleLinear().domain(linkExtent).range([1, 5]);\n        sankeydata.links.forEach(function (link) {\n          link.freq = frequencyScale(link.value);\n          link.particleSize = particleSize(link.value);\n          link.particleColor = d3.scaleLinear().domain([0, 1000]).range([link.source.color, link.target.color]);\n        });\n        var t = d3.timer(tick, 2000);\n        var particles = [];\n\n        function tick(elapsed, time) {\n          particles = particles.filter(function (d) {\n            return d.time > elapsed - 2000;\n          });\n\n          if (freqCounter > 200) {\n            freqCounter = 1;\n          }\n\n          d3.selectAll(\"path.link\").each(function (d) {\n            if (d.freq >= freqCounter) {\n              var offset = (Math.random() - .5) * d.dy;\n              particles.push({\n                link: d,\n                time: elapsed,\n                offset: offset,\n                path: this\n              });\n            }\n          });\n          particleEdgeCanvasPath(elapsed);\n          freqCounter++;\n        }\n\n        function particleEdgeCanvasPath(elapsed) {\n          var context = d3.select(\"canvas\").node().getContext(\"2d\");\n          context.clearRect(0, 0, 2000, 2000);\n          context.fillStyle = \"gray\";\n          context.lineWidth = \"1px\";\n\n          for (var x in particles) {\n            var currentTime = elapsed - particles[x].time;\n            var currentPercent = currentTime / 2000 * particles[x].path.getTotalLength();\n            var currentPos = particles[x].path.getPointAtLength(currentPercent);\n            context.beginPath();\n            context.fillStyle = particles[x].link.particleColor(currentTime);\n            context.arc(currentPos.x, currentPos.y + particles[x].offset, particles[x].link.particleSize, 0, 2 * Math.PI);\n            context.fill();\n          }\n        }\n      });\n    }\n  }, {\n    key: \"createSankeyJson\",\n    value: function createSankeyJson(category) {\n      var _this6 = this;\n\n      return new Promise(function (resolve) {\n        //console.log(category)\n        var data = {};\n        data['nodes'] = [];\n        data['links'] = [];\n        var temp = [];\n        var index = {};\n\n        for (var i = 0; i < _this6.state.countries.length; i++) {\n          temp.push({\n            'name': _this6.state.countries[i]\n          });\n          index[_this6.state.countries[i]] = i;\n        }\n\n        temp.push({\n          'name': 'United-States'\n        });\n        temp.push({\n          'name': 'China'\n        });\n        data['nodes'] = temp;\n\n        if (index['China'] > index['Germany']) {\n          var c = index['Germany'];\n          index['Germany'] = index['China'];\n          index['China'] = c;\n          var d = data['nodes'][index['Germany']];\n          data['nodes'][index['Germany']] = data['nodes'][index['China']];\n          data['nodes'][index['China']] = d;\n        }\n\n        if (index['United-States'] > index['Germany']) {\n          var c = index['Germany'];\n          index['Germany'] = index['United-States'];\n          index['United-States'] = c;\n          var d = data['nodes'][index['Germany']];\n          data['nodes'][index['Germany']] = data['nodes'][index['United-States']];\n          data['nodes'][index['United-States']] = d;\n        }\n\n        var chinaIndex = index['China'];\n        var usIndex = index['United-States'];\n        temp = []; //category.forEach(d=>temp.push({\"source\":index[d.Reporter],\"target\":index[d.Partner],\"value\":d.Value}))\n\n        for (i = 0; i < category.length; i++) {\n          var source = index[category[i].Reporter];\n\n          if (source == chinaIndex) {\n            source = 11;\n          } else if (source == usIndex) {\n            source = 10;\n          }\n\n          temp.push({\n            \"source\": source,\n            \"target\": index[category[i].Partner],\n            \"value\": category[i].Value\n          });\n        } //temp.push({\"source\":12,\"target\":index['China'],\"value\":category[i].Value})\n        //temp.push({\"source\":13,\"target\":index['United-States'],\"value\":category[i].Value})\n\n\n        data['links'] = temp; //console.log(data,index)\n        //data['links'] = data['links'].filter(d=>d.source != 0 && d.source != 1)\n        //console.log(data)\n\n        if (_this6.props.trade == 'Import') {\n          for (var i = 0; i < data['links'].length; i++) {\n            var temp = 20;\n            temp = data['links'][i]['source'];\n            data['links'][i]['source'] = data['links'][i]['target'];\n            data['links'][i]['target'] = temp;\n          }\n        }\n\n        resolve(data);\n      });\n    }\n  }, {\n    key: \"upDateTitle\",\n    value: function upDateTitle() {\n      d3.select('#year').html(this.props.year);\n      d3.select('#trade').html(' ' + this.props.trade);\n\n      if (this.props.trade == 'Import') {\n        d3.select('#direction').html('from');\n      } else {\n        d3.select('#direction').html('to');\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      return React.createElement(\"div\", {\n        id: \"sankey\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 600\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        id: \"sankey-discription-container\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 602\n        },\n        __self: this\n      }, React.createElement(\"h2\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 603\n        },\n        __self: this\n      }, React.createElement(\"span\", {\n        id: \"year\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 603\n        },\n        __self: this\n      }, this.props.year, \" \"), React.createElement(\"span\", {\n        id: \"trade\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 603\n        },\n        __self: this\n      }, this.props.trade), \" Flow \", React.createElement(\"span\", {\n        id: \"direction\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 603\n        },\n        __self: this\n      }, \"to\"), \" U.S. & China\"), React.createElement(\"p\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 604\n        },\n        __self: this\n      }, \"Sankey diagram shows how the trade flow from the top 10 countries (with the highest trade value) to the U.S. and China.\", React.createElement(\"br\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 604\n        },\n        __self: this\n      }), \"The donut chart(s) will show the breakdown trade information by category.\"), \" \", React.createElement(\"div\", {\n        id: \"instruction-box\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 605\n        },\n        __self: this\n      }, React.createElement(\"p\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 605\n        },\n        __self: this\n      }, \"Instruction: Choose Year, Trade(Export/Import), Country on sidebar, the trading flow will be shown \", React.createElement(\"br\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 605\n        },\n        __self: this\n      }), \" on the sankey diagram, donut chart(s) will show the breakdown trade information by category.\"))), React.createElement(\"div\", {\n        id: \"sankey-container\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 608\n        },\n        __self: this\n      }), React.createElement(Pie, {\n        year: this.props.year,\n        trade: this.props.trade,\n        country: this.props.country,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 609\n        },\n        __self: this\n      }));\n    }\n  }]);\n\n  return SankeyGraph;\n}(Component);\n\nexport { SankeyGraph as default };","map":{"version":3,"sources":["/Users/pzq317/Desktop/bacdata-web/src/Sankey.js"],"names":["React","Component","d3","json","csv","categoryData","sankeyJson","Sankey","TimeLine","TradeBtn","Pie","Line","SankeyGraph","props","state","data","category","countries","sankey","width","height","margin","country","y","count","piechartshow","upDate","bind","setData","drawChart","nextProps","nextState","trade","year","top","right","bottom","left","select","style","slice","nodeWidth","nodePadding","size","setState","d","Country","Year","Trade","Value","then","window","addEventListener","upDateTitle","Promise","resolve","filter","sort","a","b","map","includes","Reporter","Partner","Product","createSankeyJson","sankeydata","formatNumber","format","color","scaleOrdinal","svg","append","attr","path","link","freqCounter","nodes","links","layout","div","selectAll","enter","source","name","Math","max","dy","on","setCountry","id","html","target","convert","value","labelValue","abs","Number","round","event","pageX","pageY","rect","text","x","e","countryStatus","linkExtent","extent","frequencyScale","scaleLinear","domain","range","particleSize","forEach","freq","particleColor","t","timer","tick","particles","elapsed","time","each","offset","random","push","particleEdgeCanvasPath","context","node","getContext","clearRect","fillStyle","lineWidth","currentTime","currentPercent","getTotalLength","currentPos","getPointAtLength","beginPath","arc","PI","fill","console","log","relayout","transition","duration","exit","remove","temp","index","i","length","c","chinaIndex","usIndex"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport * as d3 from 'd3'\nimport json from './data/world.json'\nimport csv from './data/world_trade_value.csv'\nimport categoryData from './data/category.csv'\nimport sankeyJson from './data/sankeyTest.json'\n//import {sankey as Sankey, sankeyLinkHorizontal} from 'd3-sankey'\nimport {Sankey} from './d3.sankey.js'\nimport TimeLine from './TimeLine'\nimport TradeBtn from './TradeBtn'\nimport Pie from './PieChart'\nimport Line from './BarChart'\nexport default class SankeyGraph extends Component{\n\tconstructor(props){\n        super(props);\n        this.state={\n        \tdata:[],\n        \tcategory:[],\n        \tcountries:[],\n        \tsankey:{},\n        \twidth :'',\n        \theight: '',\n        \tmargin:{},\n        \tcountry:'',\n        \ty:'',\n        \tcount:0,\n        \tpiechartshow:0\n        }\n        this.upDate = this.upDate.bind(this);\n        this.setData = this.setData.bind(this);\n        this.drawChart = this.drawChart.bind(this);\n    }\n\n    shouldComponentUpdate(nextProps, nextState){\n        if(this.props.trade !== nextProps.trade || this.props.year !== nextProps.year || this.props.country !== nextProps.country ){\n            return true;\n        }\n        else{\n            return false;\n        }\n    }\n  \tcomponentDidMount() {\n\n  \t\t/*var margin = {top: 50, right: 0, bottom: 0, left: 0},\n\t\t\twidth = 700 - margin.left - margin.right,\n\t\t\theight = 500 - margin.top - margin.bottom;*/\n\t\t//console.log('sankey width', +d3.select('#section2').style('width').slice(0, -2))\n\t\tvar margin = {top: 50, right: 0, bottom: 0, left: 0},\n\t\t\twidth = +d3.select('#section2').style('width').slice(0, -2) * 0.65 - margin.left - margin.right,\n\t\t\theight = +d3.select('#section2').style('height').slice(0, -2) *0.7 - margin.top - margin.bottom;\n\n  \t\tvar sankey = Sankey()\n\t\t\t    .nodeWidth(15)\n\t\t\t    .nodePadding(10)\n\t\t\t    .size([width, height]);\n\n\t\tthis.setState({\n\t\t\tsankey :sankey,\n\t\t\twidth: width,\n\t\t\theight:height,\n\t\t\tmargin:margin\n\t\t})\n\n  \t\td3.csv(csv,function(d){\n\t\t\treturn {\n\t\t\t\tCountry : d.Country,\n\t\t\t\tYear : +d.Year,\n\t\t\t\tTrade : d.Trade,\n\t\t\t\tValue : +d.Value\n\n\t\t\t}\n\t\t}.bind(this)).then(function(data){\n    \t\tthis.setData(data).then(()=>{\n    \t\t\tthis.setState({\n    \t\t\t\tdata:data\n    \t\t\t})\n    \t\t\tthis.drawChart()\n    \t\t});\n    \t}.bind(this))\n    \twindow.addEventListener('resize', this.upDate)\n  \t}\n  \tcomponentDidUpdate(){\n  \t\tthis.setData(this.state.data).then(()=>{\n\t\t\tthis.upDate()\n\t\t\tthis.upDateTitle()\n\t\t});\n\t\t\n  \t}\n\n\n  \tsetData(data) {\n\t\t\treturn new Promise(resolve=>{\n\t\t\t\tvar countries = data.filter(d=>d.Trade == this.props.trade && d.Year == this.props.year).sort((a,b)=>{ return b.Value-a.Value }).slice(0,10).map(d=>d.Country)\n\t\t\t\tthis.setState({\n\t\t\t\t\tcountries: countries\n\t\t\t\t})\n\t\t\t\td3.csv(categoryData,function(d){\n\t\t\t\t\tvar year = this.props.year\n\t\t\t\t\tif(d.Trade == this.props.trade && countries.includes(d.Reporter) )\n\t\t\t\t\treturn {\n\t\t\t\t\t\tReporter : d.Reporter,\n\t\t\t\t\t\tPartner : d.Partner,\n\t\t\t\t\t\tProduct : d.Product,\n\t\t\t\t\t\tTrade : d.Trade,\n\t\t\t\t\t\tValue : +d[year],\n\t\t\t\t\t\tYear: year\n\t\t\t\t\t}\n\t\t\t\t}.bind(this)).then(function(category){\n\t\t\t\t\tthis.setState({\n\t\t\t\t\t\tcategory: category\n\t\t\t\t\t})\n\t\t\t\t\tresolve('ture')\n\t\t\t\t}.bind(this))\n\t\t\t\t\n\t\t\t})\n\t}\n\n\tdrawChart(){\n\n\t\tvar category = this.state.category.filter(d=>d.Product == 'AllProducts')\n\t\tthis.createSankeyJson(category).then(sankeydata=>{\n\t\t\t//console.log(sankeydata)\n\t\t\tvar trade = this.props.trade\n\t\t\tvar width = this.state.width,\n\t\t\t\theight = this.state.height,\n\t\t\t\tmargin = this.state.margin\n\n\t\t\tvar formatNumber = d3.format(\",.0f\"),\n\t\t\t    format = function(d) { return formatNumber(d) + \" TWh\"; },\n\t\t\t    color = d3.scaleOrdinal([\"#191970\",\"#000080\",\"#00008B\",\"#0000CD\",\"#0000FF\",\"#4169E1\",\"#6495ED\",\"#1E90FF\",\"#00BFFF\",\"#87CEFA\"]);\n\n\t\t\tvar svg = d3.select(\"#sankey-container\")\n\t\t\t\t.append('svg')\n\t\t\t    .attr(\"width\", width + margin.left + margin.right)\n\t\t\t    .attr(\"height\", height + margin.top + margin.bottom)\n\t\t\t    .attr('id','sankey-svg')\n\n\t\t\td3.select(\"#sankey-container\")\n\t\t\t\t.append('canvas')\n\t\t\t    .attr(\"width\", width + margin.left + margin.right)\n\t\t\t    .attr(\"height\", height + margin.top + margin.bottom)\n\t\t\t    .attr('id','sankey-canvas')\n\n\t\t\t// var sankey = Sankey()\n\t\t\t//     .nodeWidth(15)\n\t\t\t//     .nodePadding(10)\n\t\t\t//     .size([width, height]);\n\t\t\tvar sankey = this.state.sankey\n\n\t\t\tvar path = sankey.link();\n\n\t\t\tvar freqCounter = 1;\n\n\n\t\t\tsankey.nodes(sankeydata.nodes)\n\t\t\t\t.links(sankeydata.links)\n\t\t\t\t.layout(32);\n\n\t\t\tvar div = d3.select('.tooltip')\n\n\t\t\tvar link = svg.selectAll(\".link\")\n\t\t\t    .data(sankeydata.links)\n\t\t\t    .enter()\n\t\t\t    .append(\"path\")\n\t\t\t  \t.attr(\"class\", \"link\")\n\t\t\t\t.attr(\"d\", path)\n\t\t\t\t.attr('id', function(d){ return d.source.name})\n\t\t\t\t.style('fill','none')\n\t\t\t\t.style('stroke','#000')\n\t\t\t\t.style('stroke-opacity',0.05)\n\t\t\t\t.attr(\"stroke-width\", function(d) { return Math.max(1, d.dy); })\n\t\t\t\t.on(\"click\", function() {\n\t\t\t\t\tsetCountry(this.id)\n\t\t\t\t})\n\t\t\t\t.on(\"mouseover\", function(d){\n\t\t\t\t\td3.selectAll('#'+this.id)\n\t\t\t\t    \t.style('stroke-opacity',0.25)\n\t\t\t\t\t\n\t\t\t\t\tdiv.style(\"opacity\", .9)\n\t\t\t\t\t\t.style('z-index',10)\n\t\t\t\t\tdiv.html(d.source.name + ' to ' + d.target.name+ '<br>'+'Value: ' + convert(d.value))\n\n\t\t\t\t\tfunction convert(labelValue) {\n\t\t\t\t        // Nine Zeroes for Billions\n\t\t\t\t        return Math.abs(Number(labelValue)) >= 1.0e+9\n\n\t\t\t\t        ? Math.round((Math.abs(Number(labelValue)) / 1.0e+9)*10)/10 + \"B\"\n\t\t\t\t        // Six Zeroes for Millions \n\t\t\t\t        : Math.abs(Number(labelValue)) >= 1.0e+6\n\n\t\t\t\t        ? Math.round((Math.abs(Number(labelValue)) / 1.0e+6)*10)/10 + \"M\"\n\t\t\t\t        // Three Zeroes for Thousands\n\t\t\t\t        : Math.abs(Number(labelValue)) >= 1.0e+3\n\n\t\t\t\t        ? Math.round((Math.abs(Number(labelValue)) / 1.0e+3)*10)/10 + \"K\"\n\n\t\t\t\t        : Math.abs(Number(labelValue));\n\n\t\t\t\t    }\n\t\t\t\t})\n\t\t\t\t.on(\"mousemove\", ()=>{\n\t\t\t\t\tdiv.style(\"left\", (d3.event.pageX + 10) + \"px\")\n\t\t\t\t\t\t.style(\"top\", (d3.event.pageY - 10) + \"px\")\n\t\t\t\t})              \n\t\t\t\t.on(\"mouseleave\",function(d){\n\t\t\t\t\td3.selectAll('#'+this.id)\n\t\t\t\t    \t.style('stroke-opacity',0.05)\n\n\t\t\t\t\tdiv.style(\"opacity\", 0)\n\t\t\t\t\t\t.style('z-index',-10)\n\t\t\t\t    \n\t\t\t\t})\n\n\t\t\t\n\t\t\tvar rect = svg.selectAll(\"rect\")\n\t\t\t  \t.data(sankeydata.nodes)\n\t\t\t    .enter()\n\n\t\t\tvar text = svg.selectAll(\"text\")\n\t\t\t  \t.data(sankeydata.nodes)\n\t\t\t    .enter()\n\t\t\t    //.append(\"g\")\n\t\t\t\t//.attr(\"class\", \"node\")\n\t\t\t\t//.attr(\"transform\", function(d) { return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n\n\n\t\t\trect.append(\"rect\")\n\t\t\t\t.attr('id','sankey-rect')\n\t\t\t\t.attr('x',function(d){ return d.x })\n\t\t\t\t.attr('y',function(d){ return d.y })\n\t\t\t\t.attr(\"height\", function(d) { return d.dy; })\n\t\t\t\t.attr(\"width\", sankey.nodeWidth())\n\t\t\t\t.style(\"fill\", function(d) { return d.color = color(d.name); })\n\t\t\t\t.style(\"stroke\", \"none\")\n\t\t\t\t.append(\"title\")\n\t\t\t\t.text(function(d) { return d.name + \"\\n\" + format(d.value); });\n\n\t\t\ttext.append(\"text\")\n\t\t\t\t.attr('id','sankey-text')\n\t\t\t\t.attr('x',function(d){ return d.x-6 })\n\t\t\t\t.attr('y',function(d){ return d.y + (d.dy / 2) })\n\t\t\t\t.attr(\"dy\", \".35em\")\n\t\t\t\t.attr(\"text-anchor\", \"end\")\n\t\t\t\t.attr(\"transform\", null)\n\t\t\t\t.text(function(d) { return d.name; })\n\t\t\t\t.filter(function(d) { return d.x < width / 2; })\n\t\t\t\t.attr(\"x\", 6 + sankey.nodeWidth())\n\t\t\t\t.attr(\"text-anchor\", \"start\");\n\n\t\t\tvar setCountry = (e)=> {\n\t\t\t\t/*console.log('set country')\n\t\t\t\tif(this.state.count == 0){\n\t\t\t\t\tthis.setState({\n\t\t\t\t\t\tcountry: e,\n\t\t\t\t\t\tcount:1,\n\t\t\t\t\t\tpiechartshow:1\n\t\t\t\t\t},this.drawPieChart)\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tthis.setState({\n\t\t\t\t\t\tcountry: e\n\t\t\t\t\t})\n\t\t\t\t}*/\n\t\t\t\tthis.props.countryStatus(e)\n\t\t\t}\n\n\n\t\t\tvar linkExtent = d3.extent(sankeydata.links, function (d) {return d.value});\n\t\t\tvar frequencyScale = d3.scaleLinear().domain(linkExtent).range([1,100]);\n\t\t\tvar particleSize = d3.scaleLinear().domain(linkExtent).range([1,5]);\n\n\n\t\t\tsankeydata.links.forEach(function (link) {\n\t\t\t\tlink.freq = frequencyScale(link.value);\n\t\t\t\tlink.particleSize = particleSize(link.value);\n\t\t\t\tlink.particleColor = d3.scaleLinear().domain([0,1000]).range([link.source.color, link.target.color]);\n\t\t\t})\n\n\t\t\tvar t = d3.timer(tick, 2000);\n\t\t\tvar particles = [];\n\n\t\t\tfunction tick(elapsed, time) {\n\t\t\t    particles = particles.filter(function (d) {return d.time > (elapsed - 2000)});\n\n\t\t\t    if (freqCounter > 200) {\n\t\t\t      \tfreqCounter = 1;\n\t\t\t    }\n\n\t\t\t    d3.selectAll(\"path.link\")\n\t\t\t    \t.each(function (d) {\n\t\t        \t\tif (d.freq >= freqCounter) {\n\t\t\t          \t\tvar offset = (Math.random() - .5) * d.dy;\n\t\t\t          \t\tparticles.push({link: d, time: elapsed, offset: offset, path: this})\n\t\t\t        \t}\n\t\t\t      \t});\n\t\t\t    \tparticleEdgeCanvasPath(elapsed);\n\t\t\t    \tfreqCounter++;\n\t\t\t}\n\n\t\t\tfunction particleEdgeCanvasPath(elapsed) {\n\t\t\t    var context = d3.select(\"canvas\").node().getContext(\"2d\")\n\n\t\t\t    context.clearRect(0,0,2000,2000);\n\n\t\t\t      \tcontext.fillStyle = \"gray\";\n\t\t\t      \tcontext.lineWidth = \"1px\";\n\t\t\t    for (var x in particles) {\n\t\t\t        var currentTime = elapsed - particles[x].time;\n\t\t\t        var currentPercent = currentTime / 2000 * particles[x].path.getTotalLength();\n\t\t\t        var currentPos = particles[x].path.getPointAtLength(currentPercent)\n\t\t\t        context.beginPath();\n\t\t\t      \tcontext.fillStyle = particles[x].link.particleColor(currentTime);\n\t\t\t        context.arc(currentPos.x,currentPos.y + particles[x].offset,particles[x].link.particleSize,0,2*Math.PI);\n\t\t\t        context.fill();\n\t\t\t    }\n\t\t\t}\n\t\t})\n\t}\n\tupDate(){\n\t\tconsole.log('sankey update')\n\t\t//d3.select('#sankey-discription-container').style('height',+d3.select('#section2').style('width').slice(0, -2) * 0.3)\n\t\tvar trade = this.props.trade\n\t\tvar category = this.state.category.filter(d=>d.Product == 'AllProducts')\n\t\tthis.createSankeyJson(category).then(sankeydata=>{\n\t\t\t//console.log('sankey update width',+d3.select('#section2').style('width').slice(0, -2))\n\t\t\tvar margin = {top: 50, right: 0, bottom: 0, left: 0},\n\t\t\t\twidth = +d3.select('#section2').style('width').slice(0, -2) * 0.65 - margin.left - margin.right,\n\t\t\t\theight = +d3.select('#section2').style('height').slice(0, -2) *0.7 - margin.top - margin.bottom;\n\n\t\t\t    // width = 1000 - margin.left - margin.right,\n\t\t\t    // height = 500 - margin.top - margin.bottom;\n\n\t\t\td3.select(\"#sankey-svg\")\n\t\t\t    .attr(\"width\", width + margin.left + margin.right)\n\t\t\t    .attr(\"height\", height + margin.top + margin.bottom)\n\n\t\t\td3.select(\"#sankey-canvas\")\n\t\t\t    .attr(\"width\", width + margin.left + margin.right)\n\t\t\t    .attr(\"height\", height + margin.top + margin.bottom)\n\n\t\t\tconsole.log(trade)\n\t\t\tvar formatNumber = d3.format(\",.0f\"),\n\t\t\t    format = function(d) { return formatNumber(d) + \" TWh\"; },\n\t\t\t    color = trade == 'Import'? d3.scaleOrdinal([\"#800000\",\"#A52A2A\",\"#B22222\",\"#FF0000\",\"#DC143C\",\"#FFA07A\",\"#FA8072\",\"#F08080\",\"#CD5C5C\",\"#D2691E\"]): d3.scaleOrdinal([\"#191970\",\"#000080\",\"#00008B\",\"#0000CD\",\"#0000FF\",\"#4169E1\",\"#6495ED\",\"#1E90FF\",\"#00BFFF\",\"#87CEFA\"]);\n\t\t\tconsole.log('color',color('China'))\n\t\t\tvar svg = d3.select(\"#sankey-container\")\n\n\t\t\t//var sankey = this.state.sankey\n\t\t\tvar sankey = Sankey()\n\t\t\t\t\t\t    .nodeWidth(15)\n\t\t\t\t\t\t    .nodePadding(10)\n\t\t\t\t\t\t    .size([width, height]);\n\t\t\tvar freqCounter = 1;\n\n\t\t\tsankey.nodes(sankeydata.nodes)\n\t\t\t\t.links(sankeydata.links)\n\t\t\t\t.layout(32);\n\n\t\t\tsankey.relayout();\n\n\t\t\tvar path = sankey.link();\n\n\t\t\tvar link = svg.selectAll(\".link\").data(sankeydata.links)\n\t\t\t    \n\t\t\tlink.transition()\n\t\t\t\t.duration(1000)\n\t\t\t\t.attr(\"d\", path)\n\t\t\t\t.attr(\"stroke-width\", function(d) { return Math.max(1, d.dy); })\n\t\t\t\t.attr('id', function(d){ return trade=='Export' ? d.source.name:d.target.name})\n\t\t\t\t//.sort(function(a, b) { return b.dy - a.dy; })\n\t\t\t\t\n\n\t\t\tlink.enter()\n\t\t\t    .append(\"path\")\n\t\t\t    .attr(\"class\", \"link\")\n\t\t\t\t.attr(\"d\", path)\n\t\t\t\t.attr('id', function(d){ return trade=='Export' ? d.source.name:d.target.name})\n\t\t\t\t.attr(\"stroke-width\", function(d) { return Math.max(1, d.dy); })\n\t\t\t\t//.sort(function(a, b) { return b.dy - a.dy; })\n\t\t\t\t\n\n\t\t\t\n\t\t\tvar rect = svg.selectAll(\"#sankey-rect\")\n\t\t\t  \t.data(sankeydata.nodes)\n\n\n\t\t\tvar text = svg.selectAll(\"#sankey-text\")\n\t\t\t  \t.data(sankeydata.nodes)\n\t\t\t\t//.attr(\"class\", \"node\")\n\t\t\t\t//.attr(\"transform\", function(d) { return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n\n\n\t\t\trect.transition()\n\t\t\t\t.duration(1000)\n\t\t\t\t.attr('x',function(d){ return d.x })\n\t\t\t\t.attr('y',function(d){ return d.y })\n\t\t\t\t.attr(\"height\", function(d) { return d.dy; })\n\t\t\t\t//.attr(\"width\", sankey.nodeWidth())\n\t\t\t\t.style(\"fill\", function(d) { return d.color = color(d.name);})\n\t\t\t\t/*.attr(\"stroke\", \"none\")\n\t\t\t\t.append(\"title\")*/\n\t\t\t\t.text(function(d) { return d.name + \"\\n\" + format(d.value); });\n\n\t\t\ttext.transition()\n\t\t\t\t.duration(1000)\n\t\t\t\t.attr('x',function(d){ return d.x-6 })\n\t\t\t\t.attr('y',function(d){ return d.y + (d.dy / 2) })\n\t\t\t\t.attr(\"dy\", \".35em\")\n\t\t\t\t.attr(\"text-anchor\", \"end\")\n\t\t\t\t.attr(\"transform\", null)\n\t\t\t\t.text(function(d) { return d.name; })\n\t\t\t\t.filter(function(d) { return d.x < width / 2; })\n\t\t\t\t.attr(\"x\", 6 + sankey.nodeWidth())\n\t\t\t\t.attr(\"text-anchor\", \"start\");\n\n\t\t\trect.enter()\n\t\t\t\t.append(\"rect\")\n\t\t\t\t.transition()\n\t\t\t\t.duration(1000)\n\t\t\t\t.attr('id','sankey-rect')\n\t\t\t\t.attr('x',function(d){ return d.x })\n\t\t\t\t.attr('y',function(d){ return d.y })\n\t\t\t\t.attr(\"height\", function(d) { return d.dy; })\n\t\t\t\t.attr(\"width\", sankey.nodeWidth())\n\t\t\t\t//.style(\"fill\", function(d) { return d.color = color(d.name); })\n\t\t\t\t.style(\"fill\", function(d) { return d.color = color(d.name);})\n\t\t\t\t.style(\"stroke\", \"none\")\n\t\t\t\t//.append(\"title\")\n\t\t\t\t//.text(function(d) { return d.name + \"\\n\" + format(d.value); });\n\n\t\t\ttext.enter()\n\t\t\t\t.append(\"text\")\n\t\t\t\t.transition()\n\t\t\t\t.duration(1000)\n\t\t\t\t.attr('id','sankey-text')\n\t\t\t\t.attr('x',function(d){ return d.x-6 })\n\t\t\t\t.attr('y',function(d){ return d.y + (d.dy / 2) })\n\t\t\t\t.attr(\"dy\", \".35em\")\n\t\t\t\t.attr(\"text-anchor\", \"end\")\n\t\t\t\t.attr(\"transform\", null)\n\t\t\t\t.text(function(d) { return d.name; })\n\t\t\t\t.filter(function(d) { return d.x < width / 2; })\n\t\t\t\t.attr(\"x\", 6 + sankey.nodeWidth())\n\t\t\t\t.attr(\"text-anchor\", \"start\");\n\n\t\t\trect.exit()\n\t\t\t\t.remove();\n\n\t\t\ttext.exit()\n\t\t\t\t.remove();\n\n\t\t\tlink.exit()\n\t\t\t\t.remove();\n\n\t\t\tvar linkExtent = d3.extent(sankeydata.links, function (d) {return d.value});\n\t\t\tvar frequencyScale = d3.scaleLinear().domain(linkExtent).range([1,100]);\n\t\t\tvar particleSize = d3.scaleLinear().domain(linkExtent).range([1,5]);\n\n\n\t\t\tsankeydata.links.forEach(function (link) {\n\t\t\t\tlink.freq = frequencyScale(link.value);\n\t\t\t\tlink.particleSize = particleSize(link.value);\n\t\t\t\tlink.particleColor = d3.scaleLinear().domain([0,1000]).range([link.source.color, link.target.color]);\n\t\t\t})\n\n\t\t\tvar t = d3.timer(tick, 2000);\n\t\t\tvar particles = [];\n\n\t\t\tfunction tick(elapsed, time) {\n\t\t\t    particles = particles.filter(function (d) {return d.time > (elapsed - 2000)});\n\n\t\t\t    if (freqCounter > 200) {\n\t\t\t      \tfreqCounter = 1;\n\t\t\t    }\n\n\t\t\t    d3.selectAll(\"path.link\")\n\t\t\t    \t.each(function (d) {\n\t\t        \t\tif (d.freq >= freqCounter) {\n\t\t\t          \t\tvar offset = (Math.random() - .5) * d.dy;\n\t\t\t          \t\tparticles.push({link: d, time: elapsed, offset: offset, path: this})\n\t\t\t        \t}\n\t\t\t      \t});\n\t\t\t    \tparticleEdgeCanvasPath(elapsed);\n\t\t\t    \tfreqCounter++;\n\t\t\t}\n\n\t\t\tfunction particleEdgeCanvasPath(elapsed) {\n\t\t\t    var context = d3.select(\"canvas\").node().getContext(\"2d\")\n\n\t\t\t    context.clearRect(0,0,2000,2000);\n\n\t\t\t      \tcontext.fillStyle = \"gray\";\n\t\t\t      \tcontext.lineWidth = \"1px\";\n\t\t\t    for (var x in particles) {\n\t\t\t        var currentTime = elapsed - particles[x].time;\n\t\t\t        var currentPercent = currentTime / 2000 * particles[x].path.getTotalLength();\n\t\t\t        var currentPos = particles[x].path.getPointAtLength(currentPercent)\n\t\t\t        context.beginPath();\n\t\t\t      \tcontext.fillStyle = particles[x].link.particleColor(currentTime);\n\t\t\t        context.arc(currentPos.x,currentPos.y + particles[x].offset,particles[x].link.particleSize,0,2*Math.PI);\n\t\t\t        context.fill();\n\t\t\t    }\n\t\t\t}\n\t\t})\n\t\t\n    }\n\n\tcreateSankeyJson(category){\n\t\treturn new Promise(resolve=>{\n\t\t\t//console.log(category)\n\n\t\t\tvar data = {}\n\t\t\t\tdata['nodes'] = []\n\t\t\t\tdata['links'] = []\n\t\t\tvar\ttemp = []\n\t\t\tvar index = {}\n\n\n\n\t\t\tfor(var i=0 ; i < this.state.countries.length; i++){\n\t\t\t\ttemp.push({'name': this.state.countries[i]}) \n\t\t\t\tindex[this.state.countries[i]] = i\n\t\t\t}\n\t\t\ttemp.push({'name': 'United-States'})\n\t\t\ttemp.push({'name': 'China'})  \n\n\t\t\tdata['nodes'] = temp\n\n\t\t\tif(index['China'] > index['Germany']){\n\t\t\t\tvar c = index['Germany']\n\t\t\t\tindex['Germany'] = index['China']\n\t\t\t\tindex['China'] = c\n\n\t\t\t\tvar d = data['nodes'][index['Germany']]\n\t\t\t\tdata['nodes'][index['Germany']] = data['nodes'][index['China']]\n\t\t\t\tdata['nodes'][index['China']] = d\n\t\t\t}\n\t\t\tif(index['United-States'] > index['Germany']){\n\t\t\t\tvar c = index['Germany']\n\t\t\t\tindex['Germany'] = index['United-States']\n\t\t\t\tindex['United-States'] = c\n\n\t\t\t\tvar d = data['nodes'][index['Germany']]\n\t\t\t\tdata['nodes'][index['Germany']] = data['nodes'][index['United-States']]\n\t\t\t\tdata['nodes'][index['United-States']] = d\n\t\t\t}\n\t\t\tvar chinaIndex = index['China']\n\t\t\tvar usIndex = index['United-States']\n\n\n\t\t\ttemp = []\n\n\t\t\t//category.forEach(d=>temp.push({\"source\":index[d.Reporter],\"target\":index[d.Partner],\"value\":d.Value}))\n\t\t\tfor(i=0 ; i < category.length; i++){\n\t\t\t\tvar source = index[category[i].Reporter]\n\t\t\t\tif(source==chinaIndex){\n\t\t\t\t\tsource = 11\n\t\t\t\t}\n\t\t\t\telse if(source==usIndex){\n\t\t\t\t\tsource = 10\n\t\t\t\t}\n\t\t\t\ttemp.push({\"source\":source,\"target\":index[category[i].Partner],\"value\":category[i].Value})\n\t\t\t}\n\t\t\t\n\t\t\t//temp.push({\"source\":12,\"target\":index['China'],\"value\":category[i].Value})\n\t\t\t//temp.push({\"source\":13,\"target\":index['United-States'],\"value\":category[i].Value})\n\t\t\t\n\t\t\tdata['links'] = temp\n\n\t\t\t//console.log(data,index)\n\n\t\t\t//data['links'] = data['links'].filter(d=>d.source != 0 && d.source != 1)\n\t\t\t//console.log(data)\n\t\t\tif(this.props.trade == 'Import'){\n\t\t\t\tfor(var i=0; i < data['links'].length ; i++){\n\t\t\t\t\tvar temp = 20\n\t\t\t\t\ttemp = data['links'][i]['source']\n\t\t\t\t\tdata['links'][i]['source'] = data['links'][i]['target']\n\t\t\t\t\tdata['links'][i]['target'] = temp\n\t\t\t\t}\n\t\t\t}\n\t\t\tresolve(data)\n\t\t})\n\t}\n\n\tupDateTitle(){\n\t\td3.select('#year').html(this.props.year)\n\t\td3.select('#trade').html( ' '+this.props.trade)\n\t\tif(this.props.trade =='Import'){\n\t\t\td3.select('#direction').html('from')\n\t\t}else{\n\t\t\td3.select('#direction').html('to')\n\t\t}\n\t}\n\n\n\trender(){\n\t\treturn(\n\n\t\t\t<div id='sankey'>\n\n\t\t\t\t<div id='sankey-discription-container'>\n\t\t\t\t\t<h2><span id='year'>{this.props.year} </span><span id='trade'>{this.props.trade}</span> Flow <span id='direction'>to</span> U.S. & China</h2>\n\t\t\t\t\t<p>Sankey diagram shows how the trade flow from the top 10 countries (with the highest trade value) to the U.S. and China.<br></br>The donut chart(s) will show the breakdown trade information by category.</p> {/*The top donut chart<br></br> is a trade value breakdown by category, from each country to the U.S., the bottom donut chart shows the same trade information for China.</p>*/} \n\t\t\t\t\t<div id='instruction-box'><p>Instruction: Choose Year, Trade(Export/Import), Country on sidebar, the trading flow will be shown <br></br> on the sankey diagram, donut chart(s) will show the breakdown trade information by category.</p></div>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<div id='sankey-container'></div>  \n\t\t\t\t<Pie year={this.props.year} trade={this.props.trade} country={this.props.country}/>\n\t\t\t</div>\n\t\t)\n\t}\n\n}"]},"metadata":{},"sourceType":"module"}